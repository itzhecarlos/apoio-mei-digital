<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Apoio MEI Digital | Formulário de atendimento</title>
    <meta
      name="description"
      content="Preencha seus dados para iniciar a regularizacao do seu MEI com atendimento online."
    />
    <link rel="icon" href="logo.ico" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <main class="lead-page">
      <section class="section">
        <div class="container">
          <div class="lead-wrapper">
            <div class="lead-intro">
              <p class="badge badge-light">Quase lá</p>
              <h1>Preencha seus dados para iniciar seu atendimento</h1>
              <p>
                Nossa equipe usa essas informações para analisar sua situação e entrar em contato com os próximos passos.
              </p>
              <a class="btn btn-outline-dark" href="./index.html">Voltar para a página inicial</a>
            </div>

            <form class="lead-form" action="#" method="post">
              <label for="nome-completo">Nome completo</label>
              <input id="nome-completo" name="nome_completo" type="text" autocomplete="name" required />

              <label for="email">E-mail</label>
              <input id="email" name="email" type="email" autocomplete="email" required />

              <label for="celular">Número de celular</label>
              <input id="celular" name="celular" type="tel" autocomplete="tel" required />

              <label for="cnpj">CNPJ da empresa</label>
              <input id="cnpj" name="cnpj" type="text" inputmode="numeric" required />

              <label class="consent-line" for="aceite-lgpd">
                <input id="aceite-lgpd" name="aceite_lgpd" type="checkbox" required />
                <span>
                  Li e aceito a
                  <a href="./politica-privacidade.html" target="_blank" rel="noopener noreferrer">
                    Política de Privacidade / LGPD
                  </a>
                </span>
              </label>

              <button class="btn" type="submit">Enviar dados</button>
            </form>
          </div>
        </div>
      </section>
    </main>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector(".lead-form");
        if (!form) return;

        form.addEventListener("submit", async (event) => {
          event.preventDefault();

          const payload = {
            full_name: document.getElementById("nome-completo")?.value?.trim() || "",
            cnpj: document.getElementById("cnpj")?.value?.trim() || "",
            email: document.getElementById("email")?.value?.trim() || "",
            whatsapp: document.getElementById("celular")?.value?.trim() || "",
            consent_lgpd: document.getElementById("aceite-lgpd")?.checked || false,
          };

          try {
            const response = await fetch("https://apoiomeidigital.app.n8n.cloud/webhook/leat-to-pix", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await response.json();

            if (!data || data.ok === false) {
              const errorText = Array.isArray(data?.errors)
                ? data.errors.join("\n")
                : data?.message || "Não foi possível enviar os dados. Tente novamente.";
              alert(errorText);
              return;
            }

            if (data.ok === true && data.ticket_url) {
              const opened = window.open(data.ticket_url, "_blank");
              if (!opened) {
                window.location.href = data.ticket_url;
              }
            }
          } catch (error) {
            alert("Erro de conexão. Verifique sua internet e tente novamente.");
          }
        });
      });
    </script>
  </body>
</html>
