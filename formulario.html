<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Apoio MEI Digital | Formulário de atendimento</title>
    <meta
      name="description"
      content="Preencha seus dados para iniciar a regularizacao do seu MEI com atendimento online."
    />
    <link rel="icon" href="logo.ico" />
    <link rel="stylesheet" href="./styles.css" />
  </head>

  <body>
    <main class="lead-page">
      <section class="section">
        <div class="container">
          <div class="lead-wrapper">
            <div class="lead-intro">
              <p class="badge badge-light">Quase lá</p>
              <h1>Preencha seus dados para iniciar seu atendimento</h1>
              <p>
                Nossa equipe usa essas informações para analisar sua situação e
                entrar em contato com os próximos passos.
              </p>
              <a class="btn btn-outline-dark" href="./index.html">Voltar para a página inicial</a>
            </div>

            <!-- ? Evita submit padrão mesmo se JS falhar (não navega / não dá 404 por POST local) -->
            <form class="lead-form" action="javascript:void(0)" method="post" novalidate>
              <label for="nome-completo">Nome completo</label>
              <input id="nome-completo" name="nome_completo" type="text" autocomplete="name" required />

              <label for="email">E-mail</label>
              <input id="email" name="email" type="email" autocomplete="email" required />

              <label for="celular">Número de celular</label>
              <input id="celular" name="celular" type="tel" autocomplete="tel" required />

              <label for="cnpj">CNPJ da empresa</label>
              <input id="cnpj" name="cnpj" type="text" inputmode="numeric" required />

              <label class="consent-line" for="aceite-lgpd">
                <input id="aceite-lgpd" name="aceite_lgpd" type="checkbox" required />
                <span>
                  Li e aceito a
                  <a href="./politica-privacidade.html" target="_blank" rel="noopener noreferrer">
                    Política de Privacidade / LGPD
                  </a>
                </span>
              </label>

              <button class="btn" type="submit">Enviar dados</button>
            </form>
          </div>
        </div>
      </section>
    </main>
    <div id="loadingOverlay" aria-hidden="true">
      <div class="loading-card">
        <div class="spinner" aria-hidden="true"></div>
        <p>Gerando seu Pix...</p>
      </div>
    </div>

    <script>
      // ? Como o script já está no final do body, não precisa de DOMContentLoaded
      const form = document.querySelector(".lead-form");
      const overlay = document.getElementById("loadingOverlay");

      function onlyDigits(value) {
        return String(value || "").replace(/\D/g, "");
      }

      function setFormDisabled(targetForm, isDisabled) {
        if (!targetForm) return;
        const fields = targetForm.querySelectorAll("input, select, textarea, button");
        fields.forEach((field) => {
          field.disabled = isDisabled;
        });
      }

      function showLoading(targetForm) {
        if (overlay) {
          overlay.style.display = "flex";
          overlay.setAttribute("aria-hidden", "false");
        }
        setFormDisabled(targetForm, true);
      }

      function hideLoading(targetForm) {
        if (overlay) {
          overlay.style.display = "none";
          overlay.setAttribute("aria-hidden", "true");
        }
        setFormDisabled(targetForm, false);
      }

      if (form) {
        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          showLoading(form);

          const payload = {
            full_name: (document.getElementById("nome-completo")?.value || "").trim(),
            cnpj: onlyDigits(document.getElementById("cnpj")?.value || ""),
            email: (document.getElementById("email")?.value || "").trim(),
            whatsapp: onlyDigits(document.getElementById("celular")?.value || ""),
            consent_lgpd: !!document.getElementById("aceite-lgpd")?.checked,
          };

          try {
            const response = await fetch(
              "https://apoiomeidigital.app.n8n.cloud/webhook/leat-to-pix",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
              }
            );

            // ? Se a resposta não for JSON, evita quebrar o fluxo
            const contentType = response.headers.get("content-type") || "";
            let data = null;

            if (contentType.includes("application/json")) {
              data = await response.json();
            } else {
              const text = await response.text();
              // Ajuda a debugar se veio HTML/erro
              console.error("Resposta não-JSON do webhook:", text);
              alert("O servidor retornou uma resposta inesperada. Tente novamente em instantes.");
              return;
            }

            if (!response.ok || !data || data.ok === false) {
              const errorText = Array.isArray(data?.errors)
                ? data.errors.join("\n")
                : data?.message || "Não foi possível enviar os dados. Tente novamente.";
              alert(errorText);
              return;
            }

            if (data.ok === true) {
              if (typeof data.ticket_url === "string") {
                sessionStorage.setItem("ticket_url", data.ticket_url);
              }
              if (typeof data.qr_code === "string") {
                sessionStorage.setItem("qr_code", data.qr_code);
              }
              window.location.href = "./enviado.html";
              return;
            }

            alert("Pix gerado, mas não recebemos os dados esperados. Tente novamente.");
          } catch (error) {
            console.error(error);
            alert("Erro de conexão. Verifique sua internet e tente novamente.");
          } finally {
            hideLoading(form);
          }
        });
      }
    </script>
  </body>
</html>